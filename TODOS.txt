o código ta um locura, tenta abstrair o que der.

Tem varias coisas, especialmente os checks se ja existe, se os tipos estao corretos etc etc

fiz mta coisa de chamada de função já tb, mas faltou os pipes e os f(.) 

acho que de declaração de variavel global, novo tipo, criação de função, declaração loca etc ta feito, tem que arrumar só pra ver em qual tabela vai inserir 
e buscar, mas não deve ser uma mudança TAO grande.

boa sorte com esse código.

desculpa to com sono

schnorr mt troll
abraço